# Select image from https://hub.docker.com/_/php/
image: registry.gitlab.com/wearesmile/glass:latest

# Select what we should cache
cache:
  paths:
  - vendor/
  - node_modules/

# before_script:

stages:
  - test
  - deploy

#codingstandards:
#  stage: test
#  only:
#  - testing
#  - staging
#  - production
#  script:
#  - files=$(git ls-files -om --exclude-standard '*.php')
#  - phpcs -p -s -v -n . --extensions=php --ignore=/vendor,/node_modules,/bower_components,/inc/class-tgm-plugin-activation.php $files

#jslint:
#  script:
#  - cd $CI_PROJECT_DIR
#  - jscs .
#  - jshint .

phplint:
  stage: test
  only:
  - testing
  - staging
  - production
  script:
  - cd $CI_PROJECT_DIR
  - find . -type d \( -path ./vendor -o -path ./plugins \) -prune -o \( -name '*.php' \) -exec php -lf {} \;

testing:
  stage: deploy
  environment:
    name: Testing
  only:
    - testing
  script:
    - mkdir -p ~/.ssh
    - eval "$(ssh-agent)"
    - DIRECTORY=/srv/testing/public_html/wp-content/plugins/border-control
    - echo "$STAGING_PRIVATE_KEY" | tr -d '\r' | ssh-add - > /dev/null
    - chmod 700 ~/.ssh
    - ssh -o StrictHostKeyChecking=no smile@$STAGING_IP uptime
    - if ssh -p22 smile@$STAGING_IP [ ! -d "$DIRECTORY" ]; then ssh -p22 smile@$STAGING_IP "mkdir $DIRECTORY"; fi
    - rsync -ravp --exclude-from=$CI_PROJECT_DIR/deploy/exclude-list.txt --delete-excluded $CI_PROJECT_DIR/ smile@$STAGING_IP:$DIRECTORY

staging:
  stage: deploy
  environment:
    name: Staging
  only:
    - staging
  script:
    - mkdir -p ~/.ssh
    - eval "$(ssh-agent)"
    - DIRECTORY=/srv/staging/public_html/wp-content/plugins/border-control
    - echo "$STAGING_PRIVATE_KEY" | tr -d '\r' | ssh-add - > /dev/null
    - chmod 700 ~/.ssh
    - ssh -o StrictHostKeyChecking=no smile@$STAGING_IP uptime
    - if ssh -p22 smile@$STAGING_IP [ ! -d "$DIRECTORY" ]; then ssh -p22 smile@$STAGING_IP "mkdir $DIRECTORY"; fi
    - rsync -ravp --exclude-from=$CI_PROJECT_DIR/deploy/exclude-list.txt --delete-excluded $CI_PROJECT_DIR/ smile@$STAGING_IP:$DIRECTORY

production:
  stage: deploy
  environment:
    name: Production
  only:
    - production
  script:
    - mkdir -p ~/.ssh
    - eval "$(ssh-agent)"
    - DIRECTORY=/srv/wearesmile.com/public_html/wp-content/plugins/border-control
    - echo "$STAGING_PRIVATE_KEY" | tr -d '\r' | ssh-add - > /dev/null
    - chmod 700 ~/.ssh
    - ssh -o StrictHostKeyChecking=no smile@$PRODUCTION_IP uptime
    - if ssh -p22 smile@$PRODUCTION_IP [ ! -d "$DIRECTORY" ]; then ssh -p22 smile@$PRODUCTION_IP "mkdir $DIRECTORY"; fi
    - rsync -ravp --exclude-from=$CI_PROJECT_DIR/deploy/exclude-list.txt --delete-excluded $CI_PROJECT_DIR/ smile@$PRODUCTION_IP:$DIRECTORY
   